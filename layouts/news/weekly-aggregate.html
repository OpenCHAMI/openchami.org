{{ define "main" }}
<div class="row justify-content-center">
  <div class="col-md-12 col-lg-9">
    <header class="mb-4">
      <h1>{{ .Title }}</h1>
      {{ with .Content }}<div class="lead">{{ . }}</div>{{ end }}
    </header>

    {{/* Collect pages from content/news/weekly (this branch) */}}
    {{ $weekly := where (where site.RegularPages "File.Dir" "in" "/news/weekly/") "Section" "news" }}
    {{ $sorted := sort $weekly "Date" "desc" }}

    {{ if not (gt (len $weekly) 0) }}
      <p>No weekly updates found yet.</p>
    {{ else }}
      <div class="list-group list-group-flush">
        {{ range $sorted }}
          <article class="list-group-item px-0">
            <h2 class="h5 mb-1"><a class="stretched-link text-decoration-none" href="{{ .RelPermalink }}">{{ .Title }}</a></h2>
            <div class="post-meta small text-muted mb-2">
              <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "Jan 2, 2006" }}</time>
            </div>
            {{ with .Params.summary }}
              <p class="mb-0">{{ . }}</p>
            {{ else }}
              {{ with .Summary }}<p class="mb-0">{{ . }}</p>{{ end }}
            {{ end }}
          </article>
        {{ end }}
      </div>
    {{ end }}
  </div>
</div>

{{/* Inject JSON-LD for weekly updates */}}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": "Weekly Updates",
  "description": "Aggregated weekly engineering and ops updates",
  "url": "{{ .Permalink }}",
  "hasPart": [
    {{ range $sorted }}
    {
      "@type": "BlogPosting",
      "headline": "{{ .Title }}",
      "url": "{{ .Permalink }}",
      "datePublished": "{{ .Date.Format "2006-01-02" }}",
      "author": [
        {{ range .Params.contributors }}
        {
          "@type": "Person",
          "name": "{{ . }}"
        }{{ if not (eq . (index $.Params.contributors (sub (len $.Params.contributors) 1))) }},{{ end }}
        {{ end }}
      ]
    }{{ if not (eq . (index $sorted (sub (len $sorted) 1))) }},{{ end }}
    {{ end }}
  ]
}
</script>
{{ end }}