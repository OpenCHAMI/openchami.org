{{/* Fix undefined variable $sorted by moving its declaration to the top scope */}}
{{ define "main" }}
<div class="row justify-content-center">
  <div class="col-md-12 col-lg-9">
    <header class="mb-4">
      <h1>{{ .Title }}</h1>
      {{ with .Content }}<div class="lead">{{ . }}</div>{{ end }}
    </header>

    {{/* Collect newsletter issue pages (regular pages under /news/newsletters/) */}}
    {{ $issues := where (where site.RegularPages "File.Dir" "in" "/news/newsletters/") "Section" "news" }}
    {{ $sorted := sort $issues "Date" "desc" }}

    {{ if not (gt (len $issues) 0) }}
      <p>No newsletter issues published yet.</p>
    {{ else }}
      <div class="card-list">
        {{ range $sorted }}
          <div class="card my-3">
            <div class="card-body">
              <h2 class="h5 mb-1"><a class="stretched-link text-decoration-none" href="{{ .RelPermalink }}">{{ .Title }}</a></h2>
              <div class="post-meta small text-muted mb-2">
                <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "Jan 2, 2006" }}</time>
                {{ with .Params.contributors }}
                  &middot; {{/* Link contributors if possible */}}
                  {{ $all := site.Pages }}
                  {{ $linked := slice }}
                  {{ range . }}
                    {{ $name := . }}
                    {{ $page := first 1 (where $all "Title" $name) }}
                    {{ if gt (len $page) 0 }}
                      {{ $linked = $linked | append (print "<a href=" (index $page 0).RelPermalink ">" $name "</a>") }}
                    {{ else }}
                      {{ $linked = $linked | append $name }}
                    {{ end }}
                  {{ end }}
                  <span class="ms-1">By {{ delimit $linked ", " }}</span>
                {{ end }}
              </div>
              {{ with .Params.summary }}
                <p class="mb-0">{{ . }}</p>
              {{ else }}
                {{ with .Summary }}<p class="mb-0">{{ . }}</p>{{ end }}
              {{ end }}
            </div>
          </div>
        {{ end }}
      </div>
    {{ end }}
  </div>
</div>

{{/* Inject JSON-LD for newsletters */}}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": "Newsletters",
  "description": "Monthly and special OpenCHAMI newsletter issues",
  "url": "{{ .Permalink }}",
  "hasPart": [
    {{ range $sorted }}
    {
      "@type": "NewsArticle",
      "headline": "{{ .Title }}",
      "url": "{{ .Permalink }}",
      "datePublished": "{{ .Date.Format "2006-01-02" }}",
      "author": [
        {{ range .Params.contributors }}
        {
          "@type": "Person",
          "name": "{{ . }}"
        }{{ if not (eq . (index $.Params.contributors (sub (len $.Params.contributors) 1))) }},{{ end }}
        {{ end }}
      ]
    }{{ if not (eq . (index $sorted (sub (len $sorted) 1))) }},{{ end }}
    {{ end }}
  ]
}
</script>
{{ end }}
